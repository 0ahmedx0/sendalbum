import asyncio
import os
import random
from dotenv import load_dotenv
from pyrogram import Client, errors

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ù…Ù„Ù .env
load_dotenv()

API_ID = int(os.getenv("API_ID", "0"))
API_HASH = os.getenv("API_HASH")
SESSION = os.getenv("SESSION")
SOURCE_INVITE = os.getenv("CHANNEL_ID")
DEST_INVITE = os.getenv("CHANNEL_ID_LOG")
FIRST_MSG_ID = int(os.getenv("FIRST_MSG_ID", "1"))
LAST_MESSAGE_ID = int(os.getenv("LAST_MESSAGE_ID", ""))

def get_random_delay():
    """Ø§Ø®ØªÙŠØ§Ø± ØªØ£Ø®ÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø¨ÙŠÙ† 5ØŒ 10 Ø£Ùˆ 15 Ø«Ø§Ù†ÙŠØ©"""
    return random.choice([5, 10, 15])

async def fetch_messages_in_range(client: Client, chat_id: int, first_id: int, last_id: int):
    """
    ÙŠØ¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø© Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯.
    """
    messages = []
    offset_id = last_id + 1
    while True:
        batch = []
        async for message in client.get_chat_history(chat_id, offset_id=offset_id, limit=1000):
            if message.id < first_id:
                break
            batch.append(message)
        if not batch:
            break
        messages.extend(batch)
        offset_id = batch[-1].id
        if batch[-1].id < first_id:
            break
    messages = [m for m in messages if m.id >= first_id]
    messages.sort(key=lambda m: m.id)
    return messages

async def send_document_link(client: Client, dest_chat_id: int, source_chat_id: int, message):
    """
    ÙŠÙ‚ÙˆÙ… Ø¨Ø¨Ù†Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ÙˆØ¬Ù‡Ø©.
    """
    try:
        msg_id = message.id
        src = str(source_chat_id)
        if src.startswith("-100"):
            channel_part = src[4:]
        else:
            channel_part = src
        link = f"https://t.me/c/{channel_part}/{msg_id}"
        await client.send_message(dest_chat_id, f"ğŸ“Œ Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©: {link}")
        print(f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {link}")
    except errors.FloodWait as e:
        print(f"â³ FloodWait: Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± {e.value} Ø«Ø§Ù†ÙŠØ© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·")
        await asyncio.sleep(e.value + 5)
        await send_document_link(client, dest_chat_id, source_chat_id, message)
    except Exception as e:
        print(f"âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·: {str(e)}")

async def process_channel(client: Client, source_invite: str, dest_invite: str):
    """
    ÙŠÙ†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§ØªÙŠÙ†ØŒ ÙŠØ¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯ØŒ
    ÙŠØµÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙÙ‚Ø·ØŒ
    Ø«Ù… Ù„ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© Ù…Ø³ØªÙ†Ø¯ ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ (5ØŒ 10 Ø£Ùˆ 15 Ø«Ø§Ù†ÙŠØ©).
    """
    try:
        source_chat = await client.join_chat(source_invite)
        print("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…ØµØ¯Ø±")
    except errors.UserAlreadyParticipant:
        source_chat = await client.get_chat(source_invite)
        print("âœ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø´Ø§Ø±Ùƒ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…ØµØ¯Ø±")
    
    try:
        dest_chat = await client.join_chat(dest_invite)
        print("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ÙˆØ¬Ù‡Ø©")
    except errors.FloodWait as e:
        print(f"âš ï¸ FloodWait: Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± {e.value} Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ÙˆØ¬Ù‡Ø©.")
        await asyncio.sleep(e.value + 5)
        dest_chat = await client.join_chat(dest_invite)
    except errors.UserAlreadyParticipant:
        dest_chat = await client.get_chat(dest_invite)
        print("âœ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø´Ø§Ø±Ùƒ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ÙˆØ¬Ù‡Ø©")
    
    print("ğŸ” Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯...")
    all_messages = await fetch_messages_in_range(client, source_chat.id, FIRST_MSG_ID, LAST_MESSAGE_ID)
    print(f"ğŸ” ØªÙ… Ø¬Ù„Ø¨ {len(all_messages)} Ø±Ø³Ø§Ù„Ø© Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚")
    
    # ØªØµÙÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙÙ‚Ø·
    doc_messages = [m for m in all_messages if m.document]
    print(f"ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {len(doc_messages)} Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø³ØªÙ†Ø¯Ø§Øª")
    
    for msg in doc_messages:
        delay = get_random_delay()
        print(f"â³ Ø³ÙŠØªÙ… Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± {delay} Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ (ID: {msg.id})")
        await asyncio.sleep(delay)
        await send_document_link(client, dest_chat.id, source_chat.id, msg)
        
    print("âœ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø±ÙˆØ§Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª!")

async def main():
    async with Client(
        name="document_link_bot",
        api_id=API_ID,
        api_hash=API_HASH,
        session_string=SESSION
    ) as client:
        print("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
        await process_channel(client, SOURCE_INVITE, DEST_INVITE)

if __name__ == "__main__":
    print("ğŸ”¹ Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...")
    asyncio.run(main())
